{% extends 'base.html' %}
{% block title %}Presupuesto{% endblock %}
{% block content %}
<div class="flex-col pt-4 pb-4 bg-body max-w-full min-h-screen">    
  <p class="text-3xl font-semibold text-ilumina text-center pt-8 pb-6">AJUSTE PRESUPUESTO</p>
     <!-- Barra de Filtro -->
  <div class="flex flex-col items-center justify-center mt-4" id="table-div">
    <div class="flex space-x-3 items-center mb-7">
      <p class="text-ilumina text-lg">Aplicar Filtro</p>
      <select id="filter-field" class="border p-2  bg-white rounded-md"></select>
      <select id="filter-type" class="border p-2 bg-white rounded-md">
        <option class="border-ilumina border-1" value="like">Contiene</option>
        <option value="=">Igual</option>
        <option value="!=">Diferente</option>
        <option value="<">Menor que</option>
        <option value="<=">Menor o igual</option>
        <option value=">">Mayor que</option>
        <option value=">=">Mayor o igual</option>
      </select>
      <input id="filter-value" type="text" placeholder="Valor..." class="border p-2 rounded-md bg-white">
      <button id="filter-clear" class="border px-3 py-2 rounded-md bg-iluminad cursor-pointer">Limpiar</button>
    </div>
    <div class="w-10/12 h-120 mx-4" id="table"></div>
  </div>
  <!-- Final Barra de Filtro -->
</div>
{{ data|json_script:"data-json" }}
<script>
    const form = document.querySelector('#budgetForm');
    const csrftoken = Cookies.get('csrftoken');
    const data = JSON.parse(document.getElementById('data-json').textContent);
    const tabla = new Tabulator('#table', {
      data: data,
      nestedFieldSeparator: false,
      height:'80vh',
      autoColumns: true, 
      layout: 'fitColumns'   
    });

    tabla.on('tableBuilt', () => {
      const allCols = tabla.getColumns();
      allCols.slice(4).forEach(col => {
        col.updateDefinition({
          editor: 'number',
          formatter: "money",
          formatterParams: {
            thousand: ".",
            decimal: ",",
            precision: 0,
          },
          cellEdited: (cell) => {
            const fila = cell.getRow().getData();
            console.log(fila);
          }
        });
      });
    });
// Logica Barra de Filtro
tabla.on("tableBuilt", function () {
  const fieldSelect = document.getElementById("filter-field");
  tabla.getColumns().forEach(col => {
    const opt = document.createElement("option");
    opt.value = col.getField();
    opt.textContent = col.getDefinition().title || col.getField();
    fieldSelect.appendChild(opt);
  });
});
function updateFilter() {
  const field = document.getElementById("filter-field").value;
  const type = document.getElementById("filter-type").value;
  const value = document.getElementById("filter-value").value;
  if (field && value !== "") {
    tabla.addFilter(field, type, value);
  } else {
    tabla.clearFilter();
  }
}

document.getElementById("filter-field").addEventListener("change", updateFilter);
document.getElementById("filter-type").addEventListener("change", updateFilter);
document.getElementById("filter-value").addEventListener("change", updateFilter);
document.getElementById("filter-clear").addEventListener("click", () => {
  document.getElementById("filter-value").value = "";
  tabla.clearFilter();
});
// Fin logica barra de filtro

        

</script>
{% endblock %}