{% extends 'base.html' %}
{% block title %}Presupuesto{% endblock %}
{% block content %}
<div class="flex-col pt-4 pb-4 bg-body max-w-full min-h-screen">    
  <p class="text-3xl font-semibold text-ilumina text-center pt-8 pb-6">PRESUPUESTO</p>
  <div class="flex justify-center gap-6">
    <form class="flex text-2xl pt-4 pb-4 justify-center items-center gap-6 min-w-fit" id="budgetForm">
      <label class="font-medium" for="ipc">Ingrese IPC:</label>
      <input
        class='rounded-lg text-ilumina border-ilumina text-xl font-semibold p-2.5 w-35 cursor-pointer border-2'
        type="number"
        name="ipc"
        id="ipc"
        placeholder="ej: 4.7"
        step="any"
      />
      <button class="rounded-lg bg-iluminab border-ilumina border-2 text-white text-xl font-semibold p-2.5 w-35 cursor-pointer" id="generate-button" type="submit">
        Generar
      </button>
      <!-- Agregar funcionalidad -->
      <button type="button" class="rounded-lg bg-iluminab border-ilumina border-2 text-white text-xl font-semibold p-2.5 w-35 cursor-pointer" id="exportButton">
        Exportar
      </button>
      <button type="button" class="rounded-lg bg-iluminab border-ilumina border-2 text-white text-xl font-semibold p-2.5 w-60 cursor-pointer" id="reportButton">
        <a href="{% url 'report' %}">Reporte Cuentas Negativas</a>
      </button>

    </form>
    <form class="flex pt-4 pb-4 min-w-fit justify-center items-center" id="savingForm">
      {% csrf_token %}
      <button type="submit" class="rounded-lg border-ilumina border-2 text-ilumina font-semibold text-xl p-2.5 w-60 cursor-pointer">
        Guardar para ajuste
      </button>
    </form>
    <div id="message" class="mt-4 p-2 rounded-lg bg-white text-green-700 hidden"></div>
  </div>
    <!-- Barra de Filtro -->
  <div class="flex flex-col items-center justify-center mt-6" id="table-div">
    <div class="flex space-x-3 items-center mb-7">
      <p class="text-ilumina text-lg">Aplicar Filtro</p>
      <select id="filter-field" class="border p-2  bg-white rounded-md"></select>
      <select id="filter-type" class="border p-2 bg-white rounded-md">
        <option class="border-ilumina border-1" value="like">Contiene</option>
        <option value="=">Igual</option>
        <option value="!=">Diferente</option>
        <option value="<">Menor que</option>
        <option value="<=">Menor o igual</option>
        <option value=">">Mayor que</option>
        <option value=">=">Mayor o igual</option>
      </select>
      <input id="filter-value" type="text" placeholder="Valor..." class="border p-2 rounded-md bg-white">
      <button id="filter-clear" class="border px-3 py-2 rounded-md bg-iluminad cursor-pointer">Limpiar</button>
    </div>
    <div class="w-11/12 h-120 mx-4" id="table"></div>
  </div>
  <!-- Final Barra de Filtro -->
</div>
<script>
  var table;
  const form = document.querySelector('#budgetForm');
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const ipc = parseFloat(document.getElementById('ipc').value);
    if (!ipc) {
        alert('IPC no puede ser vacío');
        return;
    }

    const response = await fetch("{% url 'budget' %}", {
      method: "POST",
      headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrftoken, 
      },
      body: new URLSearchParams({'ipc':ipc})
      });

    if (response.ok) {
      const jsonData = await response.json();
      table = new Tabulator('#table', {
        data: jsonData,
        nestedFieldSeparator: false,
        height:'80vh',
        autoColumns: true,
      });
      table.on('tableBuilt', () => {
        const allCols = table.getColumns();
        const fieldSelect = document.getElementById("filter-field");
        fieldSelect.innerHTML = ''
        allCols.forEach(col => {
        const opt = document.createElement("option");
        opt.value = col.getField();
        opt.textContent = col.getDefinition().title || col.getField();
        fieldSelect.appendChild(opt);
        });
        allCols.slice(4).forEach(col => {
          col.updateDefinition({
            formatter: "money",
            formatterParams: {
              thousand: ".",
              decimal: ",",
              precision: 0,
            },
          });
        });
      });

      // Logica Barra de Filtro
      function updateFilter() {
        const field = document.getElementById("filter-field").value;
        const type = document.getElementById("filter-type").value;
        const value = document.getElementById("filter-value").value;
        if (field && value !== "") {
          table.addFilter(field, type, value);
        } else {
          table.clearFilter();
        }
      }

      document.getElementById("filter-field").addEventListener("change", updateFilter);
      document.getElementById("filter-type").addEventListener("change", updateFilter);
      document.getElementById("filter-value").addEventListener("change", updateFilter);
      document.getElementById("filter-clear").addEventListener("click", () => {
        document.getElementById("filter-value").value = "";
        table.clearFilter();
      });
      // Fin logica barra de filtro
    }
  });


  document.querySelector('#exportButton').addEventListener('click', () => {
    if (table) table.download('xlsx', 'Presupuesto.xlsx');
    else alert('No hay tabla para exportar');
  });

  document.addEventListener("DOMContentLoaded", () => {
    const form2 = document.querySelector('#savingForm');
    form2.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!table) {
        alert('Debe generar una tabla primero');
        return;
      }

      const data = table.getData();
      const reducedData = data.map(row => ({
        cc_code: row["Centro de Costos"],
        cc_name: row["Nombre Centro de Costos"],
        acc_code: row["Cuenta Contable"],
        acc_name: row["Nombre Cuenta"],
        calculated_amount: row["Presupuesto Calculado"]
      }));

      console.log("Enviando datos:", reducedData);

      const messageBox = document.getElementById('message');
      messageBox.classList.remove('hidden');
      messageBox.textContent = 'Guardando tabla...';

      try {
        const response = await fetch("{% url 'save_adjust_budget' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify(reducedData),
        });

        console.log("Status:", response.status);
        const json = await response.json();
        console.log("Respuesta:", json);

        if (response.ok) {
          messageBox.textContent = json.detail || 'Tabla guardada correctamente ✅';
        } else {
          messageBox.textContent = json.detail || 'Error al guardar los datos ❌';
        }
      } catch (err) {
        console.error("Error:", err);
        messageBox.textContent = 'Error de red o servidor no disponible ❌';
      }
    });
  });

</script>
{% endblock %}