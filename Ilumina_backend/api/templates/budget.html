{% extends 'base.html' %}
{% block title %}Presupuesto{% endblock %}
{% block content %}
<div class="flex-col pt-4 pb-4 bg-body max-w-full min-h-screen">    
        <p class="text-4xl font-semibold text-ilumina text-center pt-10 pb-6">PRESUPUESTO</p>
        <div class="flex justify-center">
          <form class="flex text-2xl pt-4 pb-4 justify-center items-center gap-6 min-w-full" id="budgetForm">
            <input
              class='rounded-lg text-ilumina font-semibold border-ilumina p-3 w-50 border-2 placeholder-ilumina'
              type="number"
              name="ipc"
              id="ipc"
              placeholder="Ingrese IPC"
              step="any"
            />
            <button
              class="rounded-lg bg-iluminab border-ilumina border-2 text-white font-semibold p-3 w-50 cursor-pointer"
              type="submit"
            >
              Generar
            </button>
            <!-- Agregar funcionalidad -->
            <button type="button" class="rounded-lg bg-iluminab border-ilumina border-2 text-white font-semibold p-3 w-50 cursor-pointer" id="exportButton">
              Exportar
            </button>
          </form>
        </div>
    <!-- Barra de Filtro -->
  <div class="flex flex-col items-center justify-center" id="table-div">
    <div class="flex space-x-2 mb-2">
      <select id="filter-field" class="border p-2 bg-white rounded"></select>
      <select id="filter-type" class="border p-2 bg-white rounded">
        <option value="like">Contiene</option>
        <option value="=">Igual</option>
        <option value="!=">Diferente</option>
        <option value="<">Menor que</option>
        <option value="<=">Menor o igual</option>
        <option value=">">Mayor que</option>
        <option value=">=">Mayor o igual</option>
      </select>
      <input id="filter-value" type="text" placeholder="Valor..." class="border p-2 rounded bg-white">
      <button id="filter-clear" class="border px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Limpiar</button>
    </div>
    <div class="w-11/12 h-120 mx-4" id="table"></div>
  </div>
  <!-- Final Barra de Filtro -->
      </div>
      <script>
    var tabla;
    const form = document.querySelector('#budgetForm');
    const csrftoken = Cookies.get('csrftoken');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const ipc = parseFloat(document.getElementById('ipc').value);
        if (!ipc) {
            alert('IPC no puede ser vacÃ­o');
            return;
        }

  const response = await fetch("{% url 'budget' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken, 
            },
            body: {'ipc':ipc}
            });
  if (response.ok) {
    const jsonData = await response.json();
    tabla = new Tabulator('#table', {
      data: jsonData,
      nestedFieldSeparator: false,
      height:'80vh',
      autoColumns: true,
    });
    tabla.on('tableBuilt', () => {
      const allCols = tabla.getColumns();
      const fieldSelect = document.getElementById("filter-field");
      fieldSelect.innerHTML = ''
      allCols.forEach(col => {
      const opt = document.createElement("option");
      opt.value = col.getField();
      opt.textContent = col.getDefinition().title || col.getField();
      fieldSelect.appendChild(opt);
      });
      allCols.slice(4).forEach(col => {
        col.updateDefinition({
          editor: 'number',
          formatter: "money",
          formatterParams: {
            thousand: ".",
            decimal: ",",
            precision: 0,
          },
          cellEdited: (cell) => {
            const fila = cell.getRow().getData();
            console.log(fila);
          }
        });
      });
    });
    // Logica Barra de Filtro
function updateFilter() {
  const field = document.getElementById("filter-field").value;
  const type = document.getElementById("filter-type").value;
  const value = document.getElementById("filter-value").value;
  if (field && value !== "") {
    tabla.addFilter(field, type, value);
  } else {
    tabla.clearFilter();
  }
}

document.getElementById("filter-field").addEventListener("change", updateFilter);
document.getElementById("filter-type").addEventListener("change", updateFilter);
document.getElementById("filter-value").addEventListener("change", updateFilter);
document.getElementById("filter-clear").addEventListener("click", () => {
  document.getElementById("filter-value").value = "";
  tabla.clearFilter();
});
// Fin logica barra de filtro
  }
});


document.getElementById('exportButton').addEventListener('click', () => {
  if (tabla) tabla.download('xlsx', 'Presupuesto.xlsx');
  else alert('No hay tabla para exportar');
});

        

      </script>
{% endblock %}