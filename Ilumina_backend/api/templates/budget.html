{% extends 'base.html' %}
{% block title %}Presupuesto{% endblock %}
{% block content %}
<div class="flex-col pt-4 pb-4 bg-iluminab max-w-full min-h-screen">    
        <p class="text-4xl font-semibold text-white text-center pt-10">PRESUPUESTACIÓN</p>
        <div class="flex justify-center">
          <form class="flex text-2xl pt-4 pb-4 justify-center items-center gap-6 min-w-full" id="budgetForm">
            <input
              class='rounded-2xl text-black font-semibold bg-white border-ilumina px-3 py-2 w-50'
              type="number"
              name="ipc"
              id="ipc"
              placeholder="Ingrese IPC"
              step="any"
            />
            <button
              class="rounded-2xl bg-iluminac text-white font-semibold px-3 py-2 w-50 cursor-pointer"
              type="submit"
            >
              Generar
            </button>
            <!-- Agregar funcionalidad -->
            <button class="rounded-2xl bg-iluminac text-white font-semibold px-3 py-2 w-50 cursor-pointer">
              Exportar
            </button>
          </form>
        </div>
        <div class="flex justify-center">
          <div class="w-8xl h-120 mx-4" id="table"></div>
        </div>
      </div>
      <script>
    const tabla = document.querySelector('#table');
    const form = document.querySelector('#budgetForm');
    const csrftoken = Cookies.get('csrftoken');
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const ipc = parseFloat(document.getElementById('ipc').value);
        if (!ipc) {
            alert('IPC no puede ser vacío');
            return;
        }

  const response = await fetch("{% url 'budget' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken, 
            },
            body: {'ipc':ipc}
            });
  if (response.ok) {
    const jsonData = await response.json();
    console.log(jsonData);
    tabla = new Tabulator('#table', {
      data: jsonData,
      nestedFieldSeparator: false,
      height:'80vh',
      autoColumns: true,
    });

    tabla.on('tableBuilt', () => {
      const allCols = tabla.getColumns();
      allCols.slice(4).forEach(col => {
        col.updateDefinition({
          editor: 'number',
          formatter: "money",
          formatterParams: {
            thousand: ".",
            decimal: ",",
            precision: 0,
          },
          cellEdited: (cell) => {
            const fila = cell.getRow().getData();
            console.log(fila);
          }
        });
      });
    });
  }
});

// document.getElementById('exportButton').addEventListener('click', () => {
//   if (tabla) tabla.download('xlsx', 'Presupuesto.xlsx');
//   else alert('No hay tabla para exportar');
// });

        

      </script>
{% endblock %}