{% extends 'base.html' %}
{% block title %}Ajuste Presupuesto{% endblock %}

{% block content %}
<div class="flex-col pt-4 pb-4 bg-body max-w-full min-h-screen">    
    <p class="text-3xl font-semibold text-ilumina text-center pt-8 pb-6">AJUSTE DE PRESUPUESTO</p>
    <div class="flex justify-center gap-6">
      <button id="saveChanges"
      class="rounded-lg bg-iluminab border-ilumina border-2 text-white text-xl font-semibold p-2.5 cursor-pointer">
        Guardar Cambios
      </button>
      <button type="button" class="rounded-lg bg-iluminab border-ilumina border-2 text-white text-xl font-semibold p-2.5 w-35 cursor-pointer" id="exportButton">
        Exportar
      </button>
    </div>
    
    <div id="message" class="mt-4 p-2 rounded-lg bg-white text-green-700 hidden"></div>
  </button>
    <!-- Barra de Filtro -->
  <div class="flex flex-col items-center justify-center mt-6" id="table-div">
    <div class="flex space-x-3 items-center mb-7">
      <p class="text-ilumina text-lg">Aplicar Filtro</p>
      <select id="filter-field" class="border p-2  bg-white rounded-md"></select>
      <select id="filter-type" class="border p-2 bg-white rounded-md">
        <option class="border-ilumina border-1" value="like">Contiene</option>
        <option value="=">Igual</option>
        <option value="!=">Diferente</option>
        <option value="<">Menor que</option>
        <option value="<=">Menor o igual</option>
        <option value=">">Mayor que</option>
        <option value=">=">Mayor o igual</option>
      </select>
      <input id="filter-value" type="text" placeholder="Valor..." class="border p-2 rounded-md bg-white">
      <button id="filter-clear" class="border px-3 py-2 rounded-md bg-iluminad cursor-pointer">Limpiar</button>
    </div>
    <div class="w-11/12 h-120 mx-4" id="table"></div>
  </div>
  <!-- Final Barra de Filtro -->
</div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    var table;
    const csrftoken = Cookies.get('csrftoken');
    const messageBox = document.getElementById("message");

    try {
      // 1️⃣ Obtener registros desde Django
      const response = await fetch("{% url 'table_adjust_budget' %}");
      const data = await response.json();

      // 2️⃣ Crear tabla Tabulator
      table = new Tabulator('#table', {
        data: data,
        nestedFieldSeparator: false,
        height:'80vh',
        layout: 'fitColumns',
        columns: [
          { title: "Centro de Costos", field: "cc_code", widthGrow: 1 },
          { title: "Nombre del Centro de Costos", field: "cc_name", widthGrow: 2 },
          { title: "Cuenta Contable", field: "acc_code", widthGrow: 1 },
          { title: "Nombre de Cuenta", field: "acc_name", widthGrow: 2 },
          {
            title: "Presupuesto Calculado",
            field: "calculated_amount",
            hozAlign: "right",
            formatter: "money",
            formatterParams: { thousand: ".", decimal: ",", precision: 0 },
          },
          {
            title: "Ajuste",
            field: "adjustment",
            editor: "number",
            hozAlign: "right",
            formatter: "money",
            formatterParams: { thousand: ".", decimal: ",", precision: 0 },
          },
          {
            title: "Presupuesto Final",
            field: "final_amount",
            hozAlign: "right",
            formatter: "money",
            formatterParams: { thousand: ".", decimal: ",", precision: 0 },
          },
          {
            title: "Justificación",
            field: "justification",
            editor: "textarea",
            widthGrow: 3,
          }
        ],
      });
      table.on('tableBuilt', () => {
        const allCols = table.getColumns();
        const fieldSelect = document.getElementById("filter-field");
        fieldSelect.innerHTML = ''
        allCols.forEach(col => {
        const opt = document.createElement("option");
        opt.value = col.getField();
        opt.textContent = col.getDefinition().title || col.getField();
        fieldSelect.appendChild(opt);
        });
      });

      // 3️⃣ Guardar cambios (botón superior)
      document.getElementById("saveChanges").addEventListener("click", async () => {
        const updatedData = table.getData();

        messageBox.classList.remove("hidden");
        messageBox.textContent = "Guardando cambios...";

        try {
          const saveResponse = await fetch("{% url 'update_adjust_budget' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify(updatedData),
          });

          const json = await saveResponse.json();
          messageBox.textContent = json.detail || "Cambios guardados correctamente ✅";
          messageBox.className = "mt-6 mx-auto p-2 rounded-lg bg-white text-center text-green-700 w-3/4";
          table.replaceData("{% url 'table_adjust_budget' %}");
        } catch (err) {
          messageBox.textContent = "Error al guardar los cambios ❌";
          messageBox.className = "mt-6 mx-auto p-2 rounded-lg bg-white text-center text-red-700 w-3/4";
        }
      });

    } catch (error) {
      table.innerHTML = "<p class='text-red-700 text-center py-6'>Aun no se ha guardado ninguna tabla de ajuste</p>";
      console.error(error);
    }
    
    // Logica Barra de Filtro
    function updateFilter() {
      const field = document.getElementById("filter-field").value;
      const type = document.getElementById("filter-type").value;
      const value = document.getElementById("filter-value").value;
      if (field && value !== "") {
        table.addFilter(field, type, value);
      } else {
        table.clearFilter();
      }
    }
    
    document.getElementById("filter-field").addEventListener("change", updateFilter);
    document.getElementById("filter-type").addEventListener("change", updateFilter);
    document.getElementById("filter-value").addEventListener("change", updateFilter);
    document.getElementById("filter-clear").addEventListener("click", () => {
      document.getElementById("filter-value").value = "";
      table.clearFilter();
    });
    // Fin logica barra de filtro
    
    document.querySelector('#exportButton').addEventListener('click', () => {
      if (table) table.download('xlsx', 'AjusteDePresupuesto.xlsx');
      else alert('No hay tabla para exportar');
    });
  });
    
</script>
{% endblock %}